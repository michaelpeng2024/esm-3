## lsh-代码分析
这段代码实现了基于局部敏感哈希（Locality-Sensitive Hashing, LSH）的哈希表，用于高维数据的近似最近邻搜索。具体来说，代码包含三个主要类：`LSHTable`、`LSHTokenized` 和 `LSHBitstream`。下面将逐一详细分析这些类的功能及其实现细节。

### 1. `LSHTable` 类

#### 功能：
`LSHTable` 类表示一个单独的 LSH 哈希表。它通过一组超平面（hyperplanes）将高维向量映射到低维的哈希值（tokens 或 bit vectors），从而实现近似相似度搜索。

#### 主要方法和属性：

- **初始化方法 `__init__`**：
  - **参数**：
    - `n_bits`：哈希的位数，即超平面的数量。
    - `dim`：输入向量的维度。
    - `hyperplanes`（可选）：预定义的超平面。如果未提供，将随机生成。
  - **功能**：
    - 如果未提供超平面，随机生成 `n_bits` 个维度为 `dim` 的超平面，并对每个超平面进行归一化处理。
    - 确保提供的超平面形状与 `n_bits` 和 `dim` 一致。
    - 初始化 `self.values` 为 1 左移对应位数，用于将二进制位转换为整数 token。

- **调用方法 `__call__`**：
  - **参数**：
    - `array`：输入的二维 NumPy 数组，形状为 `(n_samples, dim)`。
    - `tokenize`（可选，默认 `True`）：是否将二进制位转换为整数 token。
  - **功能**：
    - 计算输入数组与超平面的点积，得到相似度矩阵。
    - 根据相似度的正负将结果转换为二进制位（1 或 0）。
    - 如果 `tokenize` 为 `True`，将二进制位转换为整数 token 返回；否则，返回二进制位矩阵。

### 2. `LSHTokenized` 类

#### 功能：
`LSHTokenized` 类管理多个 `LSHTable` 实例，实现多表哈希，以提高哈希的精度和鲁棒性。它支持加载和保存超平面，允许在多个哈希表之间生成联合的哈希 token。

#### 主要方法和属性：

- **初始化方法 `__init__`**：
  - **参数**：
    - `n_bits`：每个哈希表的位数。
    - `dim`：输入向量的维度。
    - `num_tables`（可选，默认 `1`）：哈希表的数量。
    - `filepath`（可选）：用于加载预定义超平面的文件路径。
    - `allow_create_hyperplanes`（可选，默认 `False`）：是否允许在没有提供超平面文件的情况下生成新的超平面。
  - **功能**：
    - 如果提供了 `filepath`，加载超平面数据，并确保每个哈希表都有对应的超平面。
    - 如果未提供 `filepath` 且不允许创建超平面，抛出运行时错误。
    - 初始化 `self.tables`，包含 `num_tables` 个 `LSHTable` 实例，每个实例使用对应的超平面（如果提供）。

- **方法 `write_hyperplanes`**：
  - **参数**：
    - `filepath`：保存超平面的文件路径。
  - **功能**：
    - 将所有哈希表的超平面保存到指定文件，以便后续加载使用。

- **调用方法 `__call__`**：
  - **参数**：
    - `array`：输入的二维 NumPy 数组，形状为 `(n_samples, dim)`。
  - **功能**：
    - 对输入数组通过所有哈希表进行哈希，堆叠各个哈希表的 token，返回联合的哈希 token 矩阵。

### 3. `LSHBitstream` 类

#### 功能：
`LSHBitstream` 类类似于 `LSHTokenized`，但它只管理一个 `LSHTable` 实例，并且输出的是二进制位流（bitstream）而不是整数 token。适用于需要直接使用二进制位进行进一步处理的场景。

#### 主要方法和属性：

- **初始化方法 `__init__`**：
  - **参数**：
    - `n_bits`：哈希的位数。
    - `dim`：输入向量的维度。
    - `filepath`（可选）：用于加载预定义超平面的文件路径。
    - `allow_create_hyperplanes`（可选，默认 `False`）：是否允许在没有提供超平面文件的情况下生成新的超平面。
  - **功能**：
    - 如果提供了 `filepath`，加载超平面数据。
    - 如果未提供 `filepath` 且不允许创建超平面，抛出运行时错误。
    - 初始化 `self.table` 为一个 `LSHTable` 实例，使用加载或随机生成的超平面。

- **方法 `write_hyperplanes`**：
  - **参数**：
    - `filepath`：保存超平面的文件路径。
  - **功能**：
    - 将哈希表的超平面保存到指定文件。

- **调用方法 `__call__`**：
  - **参数**：
    - `array`：输入的二维 NumPy 数组，形状为 `(n_samples, dim)`。
  - **功能**：
    - 对输入数组通过哈希表进行哈希，返回二进制位矩阵（不进行 token 化）。

### 总结

整体来看，这段代码提供了一套灵活的 LSH 实现，支持以下功能：

1. **单表和多表哈希**：通过 `LSHTable`、`LSHTokenized` 和 `LSHBitstream` 类，可以选择使用单个哈希表或多个哈希表进行数据哈希。
2. **超平面的加载与保存**：支持从文件加载预定义的超平面，或在允许的情况下随机生成新的超平面，并将其保存以便复用。
3. **哈希输出的灵活性**：可以选择将哈希结果作为整数 token（便于存储和索引）或二进制位流（便于进一步的位操作和处理）。

这种设计适用于需要高效处理高维数据的应用场景，如图像检索、推荐系统和大规模数据的近似最近邻搜索等。
